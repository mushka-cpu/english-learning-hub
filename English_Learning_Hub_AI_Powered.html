<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Hub - AI Powered</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #00b894, #00d2d3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .api-setup {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
        }
        
        .api-setup.show {
            display: block;
        }
        
        .api-setup h3 {
            margin-bottom: 15px;
        }
        
        .api-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .api-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .api-input-group button {
            padding: 12px 30px;
            background: white;
            color: #e17055;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        
        .ai-powered {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #00b894, #00d2d3);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .feature-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .feature-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .feature-desc {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .content-panel {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }
        
        .content-panel.active {
            display: block;
        }
        
        .chat-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .message.ai {
            background: white;
            border: 2px solid #e9ecef;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
        }
        
        .message-input textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        
        .message-input button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            align-self: flex-end;
        }
        
        .worksheet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .worksheet-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .worksheet-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .essay-checker {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .essay-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            margin-bottom: 15px;
        }
        
        .feedback-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #00b894;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #00b894;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .exercise-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .question {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .question label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            font-family: inherit;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .video-embed {
            margin: 20px 0;
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
        }
        
        .video-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .practice-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .practice-option {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .practice-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .practice-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† English Learning Hub</h1>
            <div class="ai-badge">ü§ñ AI-Powered by Claude</div>
            <p style="margin-top: 10px; color: #666;">Your Personal English Teacher with Artificial Intelligence</p>
        </div>
        
        <!-- API Setup Banner -->
        <div id="apiSetup" class="api-setup show">
            <h3>üîë Setup Your AI Teacher</h3>
            <p>Enter your Anthropic API key to unlock AI features:</p>
            <div class="api-input-group">
                <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-xxxxx...">
                <button onclick="saveApiKey()">Save API Key</button>
            </div>
            <p style="margin-top: 10px; font-size: 13px;">
                Don't have one? Get it free at: <a href="https://console.anthropic.com" target="_blank" style="color: white; text-decoration: underline;">console.anthropic.com</a>
            </p>
        </div>
        
        <!-- Main Features Grid -->
        <div class="main-grid">
            <div class="feature-card" onclick="showPanel('worksheets')">
                <div class="feature-icon">üìö</div>
                <div class="feature-title">Full Worksheets</div>
                <div class="feature-desc">Access all your interactive worksheets with exercises, videos, and activities</div>
            </div>
            
            <div class="feature-card" onclick="showPanel('essay-checker')">
                <span class="ai-powered">AI</span>
                <div class="feature-icon">‚úçÔ∏è</div>
                <div class="feature-title">Essay Checker</div>
                <div class="feature-desc">AI analyzes your writing and gives detailed feedback on grammar, vocabulary, structure</div>
            </div>
            
            <div class="feature-card" onclick="showPanel('speaking-partner')">
                <span class="ai-powered">AI</span>
                <div class="feature-icon">üí¨</div>
                <div class="feature-title">Speaking Partner</div>
                <div class="feature-desc">Practice conversation with AI that asks questions and gives feedback</div>
            </div>
            
            <div class="feature-card" onclick="showPanel('grammar-helper')">
                <span class="ai-powered">AI</span>
                <div class="feature-icon">üìñ</div>
                <div class="feature-title">Grammar Helper</div>
                <div class="feature-desc">Ask any grammar question and get clear explanations with examples</div>
            </div>
            
            <div class="feature-card" onclick="showPanel('vocabulary')">
                <span class="ai-powered">AI</span>
                <div class="feature-icon">üéØ</div>
                <div class="feature-title">Vocabulary Builder</div>
                <div class="feature-desc">AI generates personalized exercises based on your topics</div>
            </div>
            
            <div class="feature-card" onclick="showPanel('progress')">
                <div class="feature-icon">üìä</div>
                <div class="feature-title">Progress Tracker</div>
                <div class="feature-desc">See your learning statistics and AI-powered recommendations</div>
            </div>
        </div>
        
        <!-- Worksheets Panel -->
        <div id="worksheets-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìö Your Interactive Worksheets</h2>
            <p style="color: #666; margin-bottom: 25px;">Click on any worksheet to open it with all exercises, videos, and activities</p>
            
            <div class="worksheet-grid">
                <div class="worksheet-item" onclick="openWorksheet('politics')">
                    <h3>üèõÔ∏è Politics & Government</h3>
                    <p style="color: #666; margin: 10px 0;">Level: C1 | IELTS Preparation</p>
                    <p style="font-size: 14px; color: #999;">11 videos ‚Ä¢ Gap-fill ‚Ä¢ Speaking ‚Ä¢ Writing tasks</p>
                </div>
                
                <div class="worksheet-item" onclick="openWorksheet('business')">
                    <h3>üíº Business Women & Passive Voice</h3>
                    <p style="color: #666; margin: 10px 0;">Level: B2 | Grammar Focus</p>
                    <p style="font-size: 14px; color: #999;">Photos ‚Ä¢ Videos ‚Ä¢ Grammar exercises</p>
                </div>
                
                <div class="worksheet-item" onclick="openWorksheet('crime')">
                    <h3>‚öñÔ∏è Crime & Law</h3>
                    <p style="color: #666; margin: 10px 0;">Level: B2 | Vocabulary Review</p>
                    <p style="font-size: 14px; color: #999;">Legal vocabulary ‚Ä¢ Speaking tasks</p>
                </div>
                
                <div class="worksheet-item" onclick="openWorksheet('health')">
                    <h3>üè• Health & Medicine</h3>
                    <p style="color: #666; margin: 10px 0;">Level: B2 | Vocabulary Review</p>
                    <p style="font-size: 14px; color: #999;">Medical terms ‚Ä¢ Speaking practice</p>
                </div>
                
                <div class="worksheet-item" onclick="openWorksheet('vocabulary')">
                    <h3>üì∞ News Media & Economics</h3>
                    <p style="color: #666; margin: 10px 0;">Level: B2 | Vocabulary Focus</p>
                    <p style="font-size: 14px; color: #999;">Media bias ‚Ä¢ Economic terms</p>
                </div>
            </div>
            
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 30px;">
                <p style="color: #856404;">üí° <strong>Tip:</strong> Your progress in each worksheet is automatically saved. You can return anytime and continue where you left off!</p>
            </div>
        </div>
        
        <!-- Essay Checker Panel -->
        <div id="essay-checker-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 10px;">‚úçÔ∏è AI Essay Checker</h2>
            <p style="color: #666; margin-bottom: 25px;">Paste your essay below and AI will analyze it for grammar, vocabulary, structure, and give you an IELTS-style band score</p>
            
            <div class="essay-checker">
                <textarea id="essayInput" class="essay-input" placeholder="Write or paste your essay here...

Example prompt: Some people believe censorship is necessary to protect society, while others think it limits freedom of speech. Discuss both views and give your opinion.

Write at least 250 words..."></textarea>
                
                <button class="btn-primary" onclick="checkEssay()">ü§ñ Check with AI</button>
                <button class="btn-secondary" onclick="clearEssay()">üóëÔ∏è Clear</button>
                
                <div id="essayFeedback"></div>
            </div>
        </div>
        
        <!-- Speaking Partner Panel -->
        <div id="speaking-partner-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 10px;">üí¨ AI Speaking Partner</h2>
            <p style="color: #666; margin-bottom: 25px;">Practice speaking with AI! Choose a topic and the AI will ask you questions like in IELTS Speaking test</p>
            
            <div class="practice-selector">
                <div class="practice-option" onclick="selectTopic('part1')">
                    <div style="font-size: 30px;">üë§</div>
                    <strong>Part 1</strong>
                    <p style="font-size: 12px; margin-top: 5px;">General topics</p>
                </div>
                <div class="practice-option" onclick="selectTopic('part2')">
                    <div style="font-size: 30px;">üé§</div>
                    <strong>Part 2</strong>
                    <p style="font-size: 12px; margin-top: 5px;">Long turn</p>
                </div>
                <div class="practice-option" onclick="selectTopic('part3')">
                    <div style="font-size: 30px;">üí≠</div>
                    <strong>Part 3</strong>
                    <p style="font-size: 12px; margin-top: 5px;">Discussion</p>
                </div>
                <div class="practice-option" onclick="selectTopic('free')">
                    <div style="font-size: 30px;">üó£Ô∏è</div>
                    <strong>Free Talk</strong>
                    <p style="font-size: 12px; margin-top: 5px;">Any topic</p>
                </div>
            </div>
            
            <div id="speakingChat" class="chat-container"></div>
            
            <div class="message-input">
                <textarea id="speakingInput" placeholder="Type your answer here..."></textarea>
                <button onclick="sendSpeakingMessage()">Send</button>
            </div>
        </div>
        
        <!-- Grammar Helper Panel -->
        <div id="grammar-helper-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 10px;">üìñ AI Grammar Helper</h2>
            <p style="color: #666; margin-bottom: 25px;">Ask any grammar question and get clear, detailed explanations with examples</p>
            
            <div id="grammarChat" class="chat-container">
                <div class="message ai">
                    <strong>AI Grammar Teacher:</strong><br><br>
                    Hello! I'm your grammar helper. You can ask me things like:
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>When do I use Present Perfect vs Past Simple?</li>
                        <li>What's the difference between "used to" and "would"?</li>
                        <li>How do I form conditional sentences?</li>
                        <li>Can you explain passive voice?</li>
                    </ul>
                    What would you like to learn today?
                </div>
            </div>
            
            <div class="message-input">
                <textarea id="grammarInput" placeholder="Ask your grammar question..."></textarea>
                <button onclick="sendGrammarQuestion()">Ask AI</button>
            </div>
        </div>
        
        <!-- Vocabulary Builder Panel -->
        <div id="vocabulary-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 10px;">üéØ AI Vocabulary Builder</h2>
            <p style="color: #666; margin-bottom: 25px;">Enter a topic or paste a word list, and AI will generate personalized exercises</p>
            
            <div class="exercise-section">
                <h3>Step 1: Choose or Enter Your Topic</h3>
                <input type="text" id="vocabTopic" placeholder="e.g., Business vocabulary, IELTS Politics, Crime and Law..." style="margin: 15px 0;">
                
                <p style="margin: 20px 0; color: #666;">Or paste your word list:</p>
                <textarea id="vocabList" placeholder="entrepreneur - person who starts business
revenue - income from business
stakeholder - person with interest in company" style="min-height: 150px;"></textarea>
                
                <button class="btn-primary" onclick="generateVocabExercise()">ü§ñ Generate AI Exercise</button>
                
                <div id="vocabExercise"></div>
            </div>
        </div>
        
        <!-- Progress Tracker Panel -->
        <div id="progress-panel" class="content-panel">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìä Your Progress & AI Recommendations</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 36px; color: #667eea; font-weight: bold;">5</div>
                    <div style="color: #666;">Worksheets Available</div>
                </div>
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 36px; color: #00b894; font-weight: bold;" id="aiUsage">0</div>
                    <div style="color: #666;">AI Interactions</div>
                </div>
                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; text-align: center;">
                    <div style="font-size: 36px; color: #fdcb6e; font-weight: bold;">B2-C1</div>
                    <div style="color: #666;">Current Level</div>
                </div>
            </div>
            
            <button class="btn-primary" onclick="getAIRecommendations()">ü§ñ Get AI Recommendations</button>
            
            <div id="recommendations"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let apiKey = localStorage.getItem('anthropic_api_key');
        let aiUsageCount = parseInt(localStorage.getItem('ai_usage_count') || '0');
        let currentSpeakingTopic = '';
        
        // Initialize
        if (apiKey) {
            document.getElementById('apiSetup').classList.remove('show');
        }
        
        updateAIUsage();
        
        // Save API Key
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format. It should start with "sk-ant-"');
                return;
            }
            
            localStorage.setItem('anthropic_api_key', key);
            apiKey = key;
            document.getElementById('apiSetup').classList.remove('show');
            alert('‚úÖ API Key saved! AI features are now enabled!');
        }
        
        // Show panel
        function showPanel(panelName) {
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(panelName + '-panel').classList.add('active');
        }
        
        // Open worksheet
        function openWorksheet(type) {
            const urls = {
                'politics': 'Politics_Government_IELTS_Interactive.html',
                'business': 'Business_Women_Passive_Voice_Interactive.html',
                'crime': 'Crime_Law_Review_Interactive.html',
                'health': 'Health_Medicine_Review_Interactive.html',
                'vocabulary': 'Vocabulary_Review_Interactive.html'
            };
            
            // Open in new tab
            window.open(urls[type], '_blank');
        }
        
        // Call Claude AI
        async function callClaudeAI(prompt, systemPrompt = '') {
            if (!apiKey) {
                alert('Please set up your API key first!');
                showPanel('progress');
                document.getElementById('apiSetup').classList.add('show');
                return null;
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        system: systemPrompt || undefined
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API call failed');
                }
                
                const data = await response.json();
                aiUsageCount++;
                updateAIUsage();
                
                return data.content[0].text;
            } catch (error) {
                console.error('AI Error:', error);
                alert('AI Error: ' + error.message);
                return null;
            }
        }
        
        // Update AI usage count
        function updateAIUsage() {
            localStorage.setItem('ai_usage_count', aiUsageCount.toString());
            const elem = document.getElementById('aiUsage');
            if (elem) elem.textContent = aiUsageCount;
        }
        
        // Essay Checker
        async function checkEssay() {
            const essay = document.getElementById('essayInput').value.trim();
            
            if (!essay || essay.length < 50) {
                alert('Please write at least 50 words for the AI to analyze');
                return;
            }
            
            const feedback = document.getElementById('essayFeedback');
            feedback.innerHTML = '<div class="loading"><div class="spinner"></div><p>AI is analyzing your essay...</p></div>';
            
            const prompt = `You are an expert IELTS examiner. Analyze this essay and provide detailed feedback:

Essay:
${essay}

Provide feedback on:
1. Task Achievement (did they answer the question?)
2. Coherence and Cohesion (organization and linking)
3. Lexical Resource (vocabulary range and accuracy)
4. Grammatical Range and Accuracy
5. Estimated IELTS Band Score (6.0-9.0)
6. Specific suggestions for improvement

Be constructive and encouraging while being honest about areas to improve.`;
            
            const result = await callClaudeAI(prompt);
            
            if (result) {
                feedback.innerHTML = `
                    <div class="feedback-box">
                        <h3 style="color: #00b894; margin-bottom: 15px;">ü§ñ AI Feedback</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${result}</div>
                    </div>
                `;
            } else {
                feedback.innerHTML = '';
            }
        }
        
        function clearEssay() {
            document.getElementById('essayInput').value = '';
            document.getElementById('essayFeedback').innerHTML = '';
        }
        
        // Speaking Partner
        function selectTopic(type) {
            document.querySelectorAll('.practice-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.practice-option').classList.add('selected');
            currentSpeakingTopic = type;
            
            startSpeakingSession(type);
        }
        
        async function startSpeakingSession(type) {
            const chat = document.getElementById('speakingChat');
            chat.innerHTML = '<div class="loading"><p>Starting speaking session...</p></div>';
            
            const prompts = {
                'part1': 'You are an IELTS examiner conducting Part 1 (Introduction). Ask the student 3-4 simple questions about familiar topics like work, study, hobbies, or daily life. Keep it conversational.',
                'part2': 'You are an IELTS examiner for Part 2 (Long Turn). Give the student a cue card topic and tell them to speak for 1-2 minutes. Then they will type their answer and you will give feedback.',
                'part3': 'You are an IELTS examiner for Part 3 (Discussion). Ask deeper, more abstract questions about topics like society, technology, education. Be thought-provoking.',
                'free': 'You are a friendly English conversation partner. Have a natural conversation about any topic the student wants to discuss. Be engaging and ask follow-up questions.'
            };
            
            const result = await callClaudeAI('Start the session', prompts[type]);
            
            if (result) {
                chat.innerHTML = `<div class="message ai"><strong>AI Speaking Partner:</strong><br><br>${result}</div>`;
            }
        }
        
        async function sendSpeakingMessage() {
            const input = document.getElementById('speakingInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chat = document.getElementById('speakingChat');
            chat.innerHTML += `<div class="message user">${message}</div>`;
            input.value = '';
            
            chat.innerHTML += '<div class="loading"><div class="spinner"></div></div>';
            chat.scrollTop = chat.scrollHeight;
            
            const systemPrompt = currentSpeakingTopic === 'part1' ? 
                'Continue as IELTS Part 1 examiner. Give brief feedback on their answer, then ask the next question.' :
                currentSpeakingTopic === 'part2' ?
                'Give detailed feedback on their Part 2 response: fluency, vocabulary, grammar, coherence. Be encouraging.' :
                currentSpeakingTopic === 'part3' ?
                'Continue Part 3 discussion. Comment on their answer and ask a follow-up question.' :
                'Continue natural conversation. Comment on what they said and ask a related question.';
            
            const result = await callClaudeAI(message, systemPrompt);
            
            if (result) {
                // Remove loading
                const loadingElements = chat.querySelectorAll('.loading');
                loadingElements.forEach(el => el.remove());
                
                chat.innerHTML += `<div class="message ai"><strong>AI Speaking Partner:</strong><br><br>${result}</div>`;
                chat.scrollTop = chat.scrollHeight;
            }
        }
        
        // Grammar Helper
        async function sendGrammarQuestion() {
            const input = document.getElementById('grammarInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const chat = document.getElementById('grammarChat');
            chat.innerHTML += `<div class="message user">${question}</div>`;
            input.value = '';
            
            chat.innerHTML += '<div class="loading"><div class="spinner"></div></div>';
            chat.scrollTop = chat.scrollHeight;
            
            const systemPrompt = 'You are an expert English grammar teacher. Explain grammar concepts clearly with examples. Use simple language and provide 3-4 example sentences to illustrate the point.';
            
            const result = await callClaudeAI(question, systemPrompt);
            
            if (result) {
                const loadingElements = chat.querySelectorAll('.loading');
                loadingElements.forEach(el => el.remove());
                
                chat.innerHTML += `<div class="message ai"><strong>AI Grammar Teacher:</strong><br><br>${result}</div>`;
                chat.scrollTop = chat.scrollHeight;
            }
        }
        
        // Vocabulary Builder
        async function generateVocabExercise() {
            const topic = document.getElementById('vocabTopic').value.trim();
            const wordList = document.getElementById('vocabList').value.trim();
            
            if (!topic && !wordList) {
                alert('Please enter a topic or paste a word list');
                return;
            }
            
            const container = document.getElementById('vocabExercise');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>AI is generating your personalized exercise...</p></div>';
            
            const prompt = topic ? 
                `Create a 10-question vocabulary exercise for this topic: ${topic}

Include:
1. 5 gap-fill questions (provide context sentence with blank)
2. 5 multiple choice questions (word definitions)

Make it appropriate for B2-C1 level English learners.` :
                `Using this word list, create an interactive exercise:

${wordList}

Include:
1. Gap-fill questions using these words
2. Match definitions
3. Example sentences

Format it clearly with numbered questions.`;
            
            const result = await callClaudeAI(prompt);
            
            if (result) {
                container.innerHTML = `
                    <div class="feedback-box" style="margin-top: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Your Personalized Exercise</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${result}</div>
                        <button class="btn-secondary" style="margin-top: 20px;" onclick="generateVocabExercise()">üîÑ Generate New Exercise</button>
                    </div>
                `;
            }
        }
        
        // AI Recommendations
        async function getAIRecommendations() {
            const container = document.getElementById('recommendations');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>AI is analyzing your progress and creating personalized recommendations...</p></div>';
            
            const prompt = `You are an expert English learning advisor. Based on a student who:
- Has access to 5 worksheets (Politics, Business, Crime, Health, Vocabulary)
- Is at B2-C1 level
- Has used AI features ${aiUsageCount} times
- Wants to improve for IELTS or professional English

Provide:
1. Personalized learning plan for the next 2 weeks
2. Which worksheets to focus on and in what order
3. How to use the AI features effectively
4. Daily study routine suggestion
5. Tips for rapid improvement

Be specific and actionable.`;
            
            const result = await callClaudeAI(prompt);
            
            if (result) {
                container.innerHTML = `
                    <div class="feedback-box" style="margin-top: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Your Personalized Learning Plan</h3>
                        <div style="white-space: pre-wrap; line-height: 1.8;">${result}</div>
                    </div>
                `;
            }
        }
        
        // Allow Enter key to send messages
        document.addEventListener('DOMContentLoaded', function() {
            const speakingInput = document.getElementById('speakingInput');
            const grammarInput = document.getElementById('grammarInput');
            
            if (speakingInput) {
                speakingInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendSpeakingMessage();
                    }
                });
            }
            
            if (grammarInput) {
                grammarInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendGrammarQuestion();
                    }
                });
            }
        });
    </script>
</body>
</html>
